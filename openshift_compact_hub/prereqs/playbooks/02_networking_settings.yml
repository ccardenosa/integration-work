---
- name: Configure virtual network -> Patch kernel networking
  hosts: localhost
  vars:
    hubNetwork: "{{ lookup('ansible.builtin.env', 'HUB_CLUSTER_NETWOTK_NAME') | default('hubnetwork', True) }}"
    devToConnectTo: "{{ lookup('ansible.builtin.env', 'HUB_CLUSTER_NETWOTK_BRIDGE_DEVNAME') | default('eno12399', True) }}"

  tasks:
    - name: Create bridge network
      shell: |
        nmcli con add type bridge       autoconnect yes con-name {{ hubNetwork }}-br  ifname {{ hubNetwork }}-dev stp off
        nmcli con add type bridge-slave autoconnect yes con-name {{ hubNetwork }}-dev ifname {{ devToConnectTo }} master {{ hubNetwork }}-br
        nmcli con up {{ hubNetwork }}-dev
        nmcli con show
        ip -o a

    - name: Accept RA packets to configure IPv6
      sysctl:
        name: net.ipv6.conf.all.accept_ra
        value: '2'
        state: present

    - name: Enable IPv6 forwarding in all interfaces
      sysctl:
        name: net.ipv6.conf.all.forwarding
        value: '1'
        state: present

    - name: Disable IPv6 address in loopback interface
      sysctl:
        name: net.ipv6.conf.lo.disable_ipv6
        value: '0'
        state: present

    - name: Enable IPv4 forwarding in all interfaces
      sysctl:
        name: net.ipv4.conf.all.forwarding
        value: '1'
        state: present

    # Current recommended practice in RFC3704 is to enable strict mode
    # to prevent IP spoofing from DDos attacks. If using asymmetric routing
    # or other complicated routing, then loose mode is recommended.
    # Article: https://access.redhat.com/solutions/53031
    - name: Set loose mode to netfilter when validating IPv4 packets
      sysctl:
        name: net.ipv4.conf.all.rp_filter
        value: '2'
        state: present
